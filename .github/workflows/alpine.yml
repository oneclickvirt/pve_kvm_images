name: Build Alpine Cloud Images
on:
  schedule:
    - cron: "34 16 * * *"
  workflow_dispatch:

jobs:
  build_alpine_cloud_images:
    runs-on: pve-1
    steps:
      - uses: actions/checkout@v2
      - name: check path
        run: |
          pwd
      - name: Configure Git
        run: |
          git config --global user.name "daily-update"
          git config --global user.email "tg@spiritlhl.top"
      - name: Environment preparation
        run: |
          export LIBGUESTFS_DEBUG=1
          export LIBGUESTFS_TRACE=1
          export LIBGUESTFS_BACKEND=direct
          export LIBGUESTFS_BACKEND_SETTINGS="passt:no"
          sudo apt-get update
          sudo apt-get install -y curl wget unzip zip jq libguestfs-tools rng-tools axel
      - name: Build Alpine Images
        run: |
          for version in "3.20" "3.19" "3.18"; do
              echo "=== Processing Alpine $version ==="
              rm -f alpine-${version}.qcow2 alpine-${version}-custom.qcow2 alpine${version}.qcow2
              echo "Downloading Alpine $version Cloud Image"
              download_url="https://dl-cdn.alpinelinux.org/alpine/v${version}/releases/cloud/generic_alpine-${version}.0-x86_64-bios-cloudinit-r0.qcow2"
              if curl --head --fail "$download_url"; then
                  axel -n 8 -o alpine-${version}.qcow2 "$download_url"
                  if [ $? -ne 0 ]; then
                      echo "Axel failed, trying curl"
                      curl -o alpine-${version}.qcow2 "$download_url"
                      if [ $? -ne 0 ]; then
                          echo "Failed to download Alpine $version, skipping..."
                          continue
                      fi
                  fi
              else
                  echo "Alpine $version image not available at $download_url, skipping..."
                  continue
              fi
              if [ ! -f "alpine-${version}.qcow2" ] || [ $(stat -c %s "alpine-${version}.qcow2") -lt 10485760 ]; then
                  echo "Download failed or file too small, skipping..."
                  rm -f alpine-${version}.qcow2
                  continue
              fi
              chmod 644 alpine-${version}.qcow2
              echo "Customizing Alpine $version image"
              virt-customize -a alpine-${version}.qcow2 \
                --smp 2 \
                --timezone Asia/Hong_Kong \
                --run-command "rc-update add qemu-guest-agent boot" \
                --run-command "apk update && apk upgrade" \
                --run-command "apk add sudo qemu-guest-agent bash-completion unzip wget curl net-tools iputils nano screen less vim bzip2 mtr htop bind-tools zstd cronie lsof openssh openrc" \
                --run-command "apk cache clean" \
                --append-line "/etc/conf.d/ntpd:NTPD_OPTS=\"-N -p time.apple.com -p time.windows.com\"" \
                --delete "/var/log/*.log" \
                --delete "/var/cache/apk/*" \
                --truncate "/etc/machine-id"
              if [ $? -ne 0 ]; then
                  echo "Failed to customize, skipping..."
                  rm -f alpine-${version}.qcow2
                  continue
              fi
              echo "Configuring SSH and qemu-guest-agent for Alpine $version"
              sudo virt-customize -v -x -a alpine-${version}.qcow2 --run-command "rc-update add sshd boot"
              sudo virt-customize -v -x -a alpine-${version}.qcow2 --run-command "sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/g; s/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config"
              sudo virt-customize -v -x -a alpine-${version}.qcow2 --run-command "rc-service qemu-guest-agent start"
              sudo virt-customize -v -x -a alpine-${version}.qcow2 --run-command "rc-update add qemu-guest-agent boot"
              sudo virt-customize -v -x -a alpine-${version}.qcow2 --run-command "echo root:oneclickvirt | chpasswd"
              sudo virt-customize -v -x -a alpine-${version}.qcow2 --run-command "echo '' > /etc/motd"
              sudo virt-customize -v -x -a alpine-${version}.qcow2 --run-command "echo 'Modified from https://github.com/oneclickvirt/pve_kvm_images' >> /etc/motd"
              sudo virt-customize -v -x -a alpine-${version}.qcow2 --run-command "echo 'Related repo https://github.com/spiritLHLS/pve' >> /etc/motd"
              sudo virt-customize -v -x -a alpine-${version}.qcow2 --run-command "echo '--by https://t.me/spiritlhl' >> /etc/motd"
              echo "Compressing Alpine $version image"
              virt-sparsify --compress alpine-${version}.qcow2 alpine-${version}-custom.qcow2
              if [ $? -ne 0 ]; then
                  echo "Failed to compress, skipping..."
                  rm -f alpine-${version}.qcow2 alpine-${version}-custom.qcow2
                  continue
              fi
              mv alpine-${version}-custom.qcow2 alpine${version}.qcow2
              ls -lh alpine${version}.qcow2
              file="alpine${version}.qcow2"
              if [ -f "$file" ] && [ $(stat -c %s "$file") -gt 10485760 ] && [ $(stat -c %s "$file") -le 2147483648 ]; then
                  echo "Processing file: $file"
                  release_id=$(curl -s -m 6 -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/${{ github.repository }}/releases/tags/alpine" | jq -r '.id')
                  if [ "$release_id" = "null" ] || [ -z "$release_id" ]; then
                      echo "Release 'alpine' not found, please create it first"
                      rm -f alpine-${version}.qcow2 alpine${version}.qcow2
                      continue
                  fi
                  echo "Found release ID: $release_id"
                  existing_asset_id=$(curl -s -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/${{ github.repository }}/releases/$release_id/assets" | jq -r --arg name "$(basename "$file")" '.[] | select(.name == $name) | .id')
                  if [ -n "$existing_asset_id" ] && [ "$existing_asset_id" != "null" ]; then
                      echo "Asset exists, deleting..."
                      delete_response=$(curl -s -X DELETE -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/assets/$existing_asset_id")
                      echo "$delete_response"
                      if [ $? -ne 0 ] || echo "$delete_response" | grep -q "error"; then
                          echo "Failed to delete asset, skipping upload..."
                          rm -f alpine-${version}.qcow2 alpine${version}.qcow2
                          continue
                      fi
                  fi
                  echo "Uploading $file"
                  upload_response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/octet-stream" -T "$file" "https://uploads.github.com/repos/${{ github.repository }}/releases/$release_id/assets?name=$(basename "$file")")
                  echo "Upload response: $upload_response"
                  if echo "$upload_response" | jq -e '.browser_download_url' >/dev/null; then
                      echo "Uploaded successfully"
                  else
                      echo "Upload failed"
                  fi
              else
                  echo "File missing or size not in valid range"
                  if [ -f "$file" ]; then echo "Size: $(stat -c %s "$file") bytes"; fi
              fi
              echo "Cleaning up files for Alpine $version"
              rm -f alpine-${version}.qcow2 alpine${version}.qcow2
              echo "=== Completed processing Alpine $version ==="
              echo ""
          done
          echo "All Alpine versions processed!"
