name: Build CentOS Cloud Images
on:
    schedule:
        - cron: "34 17 * * *"
    workflow_dispatch:

jobs:
    build_centos_cloud_images:
        runs-on: pve-1
        steps:
            - uses: actions/checkout@v2

            - name: check path
              run: |
                  pwd

            - name: Configure Git
              run: |
                  git config --global user.name "daily-update"
                  git config --global user.email "tg@spiritlhl.top"

            - name: Environment preparation
              run: |
                  export LIBGUESTFS_DEBUG=1
                  export LIBGUESTFS_TRACE=1
                  export LIBGUESTFS_BACKEND=direct
                  export LIBGUESTFS_BACKEND_SETTINGS="passt:no"
                  sudo bash -c 'set -e; shopt -s nullglob; for f in /etc/apt/sources.list /etc/apt/sources.list.d/*.list; do [ -f "$f" ] || continue; cp -a "$f" "$f.bak" 2>/dev/null || true; sed -i -E -e "s#(http|https)://deb.debian.org#https://mirrors.aliyun.com#g" -e "s#(http|https)://httpredir.debian.org#https://mirrors.aliyun.com#g" -e "s#(http|https)://security.debian.org#https://mirrors.aliyun.com#g" -e "s#(http|https)://security-cdn.debian.org#https://mirrors.aliyun.com#g" -e "s#(http|https)://ftp.debian.org#https://mirrors.aliyun.com#g" -e "s#(http|https)://archive.ubuntu.com#https://mirrors.aliyun.com#g" -e "s#(http|https)://security.ubuntu.com#https://mirrors.aliyun.com#g" "$f"; done; apt-get update -y'
                  sudo apt-get install -y curl wget unzip zip jq
                  sudo apt-get install -y libguestfs-tools rng-tools curl axel
                  sudo apt-get install -y libguestfs-tools rng-tools curl axel --fix-missing

            - name: Build CentOS Images
              run: |
                  declare -A centos_versions
                  centos_versions["9"]="9"
                  centos_versions["8"]="8"
                  # centos_versions["7"]="7"
                  for version in "9" "8"; do
                      echo "=== Processing CentOS $version ==="
                      rm -f centos-${version}.qcow2 centos-${version}-custom.qcow2 centos${version}.qcow2 centos-${version}.qcow2.bak
                      echo "Downloading CentOS $version Cloud Image"
                      if [ "$version" = "9" ]; then
                          download_url="https://cloud.centos.org/centos/9-stream/x86_64/images/CentOS-Stream-GenericCloud-9-latest.x86_64.qcow2"
                      elif [ "$version" = "8" ]; then
                          download_url="https://cloud.centos.org/centos/8-stream/x86_64/images/CentOS-Stream-GenericCloud-8-latest.x86_64.qcow2"
                      # elif [ "$version" = "7" ]; then
                      #     download_url="https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2"
                      fi
                      axel -n 8 -o centos-${version}.qcow2 "$download_url"
                      if [ $? -ne 0 ]; then
                          echo "Axel failed, trying with curl"
                          curl -o centos-${version}.qcow2 "$download_url"
                          if [ $? -ne 0 ]; then
                              echo "Failed to download CentOS $version, skipping..."
                              continue
                          fi
                      fi
                      if [ ! -f "centos-${version}.qcow2" ] || [ $(stat -c %s "centos-${version}.qcow2") -lt 10485760 ]; then
                          echo "Download failed or file too small for CentOS $version, skipping..."
                          rm -f centos-${version}.qcow2
                          continue
                      fi
                      chmod 644 centos-${version}.qcow2
                      echo "Customizing CentOS $version image"
                      if [ "$version" = "7" ]; then
                          package_manager="yum"
                          grub_config_path="/boot/grub2/grub.cfg"
                      else
                          package_manager="dnf"
                          grub_config_path="/boot/grub2/grub.cfg"
                      fi
                      
                      # 定义要安装的软件包列表
                      PACKAGES="sudo,qemu-guest-agent,spice-vdagent,bash-completion,unzip,wget,curl,net-tools,iputils,nano,screen,less,vim,bzip2,lldpad,mtr,htop,bind-utils,zstd,cronie,lsof"
                      
                      # 首先尝试使用官方源 + 网络安装
                      echo "Attempting network-based installation with official sources..."
                      network_install_result=0
                      virt-customize --network -a centos-${version}.qcow2 \
                        --run-command "echo 'nameserver 8.8.8.8' > /etc/resolv.conf; echo 'nameserver 1.1.1.1' >> /etc/resolv.conf" \
                        --smp 2 \
                        --timezone Asia/Hong_Kong \
                        --append-line "/etc/default/grub:# disables OS prober to avoid loopback detection which breaks booting" \
                        --append-line "/etc/default/grub:GRUB_DISABLE_OS_PROBER=true" \
                        --run-command "grub2-mkconfig -o $grub_config_path" \
                        --run-command "systemctl enable serial-getty@ttyS1.service" \
                        --update \
                        --run-command "$package_manager install -y epel-release" \
                        --install "$PACKAGES" \
                        --run-command "$package_manager -y autoremove && $package_manager -y clean all" \
                        --append-line "/etc/systemd/timesyncd.conf:NTP=time.apple.com time.windows.com" \
                        --delete "/var/log/*.log" \
                        --delete "/var/cache/yum/*" \
                        --delete "/var/cache/dnf/*" \
                        --truncate "/etc/machine-id" || network_install_result=$?
                      
                      if [ $network_install_result -ne 0 ]; then
                          echo "Network installation failed, falling back to firstboot installation..."
                          # 重新下载干净的镜像
                          rm -f centos-${version}.qcow2
                          axel -n 8 -o centos-${version}.qcow2 "$download_url" || curl -o centos-${version}.qcow2 "$download_url"
                          if [ ! -f "centos-${version}.qcow2" ] || [ $(stat -c %s "centos-${version}.qcow2") -lt 10485760 ]; then
                              echo "Failed to re-download CentOS $version for fallback, skipping..."
                              continue
                          fi
                          chmod 644 centos-${version}.qcow2
                          
                          # 对于 CentOS 8，下载换源脚本并配置阿里云源（用于 firstboot 安装）
                          if [ "$version" != "9" ]; then
                            virt-customize --network -a centos-${version}.qcow2 \
                                --run-command "echo 'nameserver 8.8.8.8' > /etc/resolv.conf; echo 'nameserver 223.5.5.5' >> /etc/resolv.conf" \
                                --run-command "curl -Lk https://gitee.com/SuperManito/LinuxMirrors/raw/main/ChangeMirrors.sh -o /root/ChangeMirrors.sh || true"
                            virt-customize -a centos-${version}.qcow2 \
                                --run-command "chmod +x /root/ChangeMirrors.sh && bash /root/ChangeMirrors.sh --source mirrors.aliyun.com --web-protocol https --intranet false --backup true --update-software false --clean-cache false --ignore-backup-tips || true"
                          fi
                          
                          # 使用 firstboot 方式安装
                          virt-customize -a centos-${version}.qcow2 \
                            --run-command "echo 'nameserver 8.8.8.8' > /etc/resolv.conf; echo 'nameserver 223.5.5.5' >> /etc/resolv.conf" \
                            --timezone Asia/Hong_Kong \
                            --append-line "/etc/default/grub:# disables OS prober to avoid loopback detection which breaks booting" \
                            --append-line "/etc/default/grub:GRUB_DISABLE_OS_PROBER=true" \
                            --run-command "grub2-mkconfig -o $grub_config_path || true" \
                            --run-command "systemctl enable serial-getty@ttyS1.service" \
                            --append-line "/etc/systemd/timesyncd.conf:NTP=time.apple.com time.windows.com" \
                            --firstboot-command "$package_manager install -y epel-release && $package_manager install -y sudo qemu-guest-agent spice-vdagent bash-completion unzip wget curl net-tools iputils nano screen less vim bzip2 lldpad mtr htop bind-utils zstd cronie lsof && systemctl enable qemu-guest-agent && systemctl start qemu-guest-agent && $package_manager -y autoremove && $package_manager -y clean all" \
                            --truncate "/etc/machine-id"
                          if [ $? -ne 0 ]; then
                              echo "Failed to configure CentOS $version with fallback method, skipping..."
                              rm -f centos-${version}.qcow2
                              continue
                          fi
                          echo "Successfully configured CentOS $version with firstboot installation method."
                      else
                          echo "Network installation succeeded for CentOS $version."
                          # 网络安装成功后，对于 CentOS 8 进行换源
                          if [ "$version" != "9" ]; then
                              echo "Replacing sources with Aliyun mirrors for end users..."
                              virt-customize --network -a centos-${version}.qcow2 \
                                  --run-command "echo 'nameserver 8.8.8.8' > /etc/resolv.conf; echo 'nameserver 223.5.5.5' >> /etc/resolv.conf" \
                                  --run-command "curl -Lk https://gitee.com/SuperManito/LinuxMirrors/raw/main/ChangeMirrors.sh -o /root/ChangeMirrors.sh || true"
                              virt-customize -a centos-${version}.qcow2 \
                                  --run-command "chmod +x /root/ChangeMirrors.sh && bash /root/ChangeMirrors.sh --source mirrors.aliyun.com --web-protocol https --intranet false --backup true --update-software false --clean-cache false --ignore-backup-tips || true"
                          fi
                      fi
                      echo "Fixing cloud-init configuration for CentOS $version..."
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/ssh_pwauth:[[:space:]]*false/ssh_pwauth: true/g' /etc/cloud/cloud.cfg"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/ssh_pwauth:[[:space:]]*0/ssh_pwauth: 1/g' /etc/cloud/cloud.cfg"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/disable_root:[[:space:]]*true/disable_root: false/g' /etc/cloud/cloud.cfg"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/disable_root:[[:space:]]*1/disable_root: 0/g' /etc/cloud/cloud.cfg"
                      echo "Configuring SSH and root access for CentOS $version..."
                      if [[ "$version" == "9" ]]; then
                          echo "Applying CentOS 9 specific SSH configuration..."
                          sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "systemctl enable sshd"
                          sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "find /etc/ssh/sshd_config.d/ -name '*.conf' -exec sed -i 's/#*PermitRootLogin.*/PermitRootLogin yes/g' {} \; 2>/dev/null || true"
                          sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "find /etc/ssh/sshd_config.d/ -name '*.conf' -exec sed -i 's/#*PasswordAuthentication.*/PasswordAuthentication yes/g' {} \; 2>/dev/null || true"
                          sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "find /etc/ssh/sshd_config.d/ -name '*.conf' -exec sed -i 's/ChallengeResponseAuthentication no/ChallengeResponseAuthentication yes/g' {} \; 2>/dev/null || true"
                      else
                          echo "Applying CentOS 8 specific SSH configuration..."
                          sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "systemctl enable sshd"
                      fi
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/#*PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/#*PasswordAuthentication.*/PasswordAuthentication yes/g' /etc/ssh/sshd_config"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/#*Port.*/Port 22/g' /etc/ssh/sshd_config"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/#*AddressFamily.*/AddressFamily any/g' /etc/ssh/sshd_config"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/#*ListenAddress 0.0.0.0.*/ListenAddress 0.0.0.0/g' /etc/ssh/sshd_config"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "sed -i 's/#*ListenAddress ::.*/ListenAddress ::/g' /etc/ssh/sshd_config"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "systemctl restart sshd"
                      echo "Configuring qemu-guest-agent for CentOS $version..."
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "systemctl start qemu-guest-agent"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "systemctl enable qemu-guest-agent"
                      echo "Applying additional system configurations for CentOS $version..."
                      if [[ "$version" == "9" ]]; then
                          sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "dnf install -y openssh-server openssh-clients"
                      else
                          sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "yum install -y openssh-server openssh-clients"
                      fi
                      echo "Setting enhanced MOTD and root password for CentOS $version..."
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "echo '' > /etc/motd"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "echo 'CentOS ${version} Stream Cloud Image' >> /etc/motd"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "echo 'Modified from https://github.com/oneclickvirt/pve_kvm_images' >> /etc/motd"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "echo 'Related repo https://github.com/spiritLHLS/pve' >> /etc/motd"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "echo '--by https://t.me/spiritlhl' >> /etc/motd"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "echo 'Default root password: oneclickvirt' >> /etc/motd"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "echo root:oneclickvirt | chpasswd"
                      echo "Applying security and performance tweaks for CentOS $version..."
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "systemctl enable crond"
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "systemctl start crond"
                      if [[ "$version" == "9" ]]; then
                          sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "dnf clean all"
                      else
                          sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "yum clean all"
                      fi
                      sudo virt-customize -v -x -a centos-${version}.qcow2 --run-command "find /var/log -type f -name '*.log' -exec truncate -s 0 {} \;"
                      echo "Creating backup and finalizing CentOS $version image"
                      cp centos-${version}.qcow2 centos-${version}.qcow2.bak
                      echo "Compressing CentOS $version image"
                      virt-sparsify --compress centos-${version}.qcow2 centos-${version}-custom.qcow2
                      if [ $? -ne 0 ]; then
                          echo "Failed to compress CentOS $version image, skipping..."
                          rm -f centos-${version}.qcow2 centos-${version}-custom.qcow2 centos-${version}.qcow2.bak
                          continue
                      fi
                      mv centos-${version}-custom.qcow2 centos${version}.qcow2
                      ls -lh centos${version}.qcow2
                      file="centos${version}.qcow2"
                      if [ -f "$file" ] && [ $(stat -c %s "$file") -gt 10485760 ] && [ $(stat -c %s "$file") -le 2147483648 ]; then
                          echo "Processing file: $file"
                          release_id=$(curl -s -m 6 -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/${{ github.repository }}/releases/tags/centos" | jq -r '.id')
                          if [ "$release_id" = "null" ] || [ -z "$release_id" ]; then
                              echo "Release 'centos' not found, please create it first"
                              rm -f centos-${version}.qcow2 centos${version}.qcow2 centos-${version}.qcow2.bak
                              continue
                          fi
                          echo "Found release ID: $release_id"
                          echo "Checking if $file already exists in release..."
                          existing_asset_id=$(curl -s -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/${{ github.repository }}/releases/$release_id/assets" | jq -r --arg name "$(basename "$file")" '.[] | select(.name == $name) | .id')
                          if [ -n "$existing_asset_id" ] && [ "$existing_asset_id" != "null" ]; then
                              echo "Asset $file already exists in release, deleting existing asset..."
                              delete_response=$(curl -s -X DELETE -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/assets/$existing_asset_id")
                              echo "$delete_response"
                              if [ $? -eq 0 ] && ! echo "$delete_response" | grep -q "error"; then
                                  echo "Existing asset deleted successfully."
                              else
                                  echo "Failed to delete existing asset for $file. Skipping file upload..."
                                  rm -f centos-${version}.qcow2 centos${version}.qcow2 centos-${version}.qcow2.bak
                                  continue
                              fi
                          else
                              echo "No existing $file file found in release."
                          fi
                          echo "Uploading $file to release..."
                          upload_response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                            -H "Content-Type: application/octet-stream" \
                            -T "$file" \
                            "https://uploads.github.com/repos/${{ github.repository }}/releases/$release_id/assets?name=$(basename "$file")")
                          echo "Upload response: $upload_response"
                          if echo "$upload_response" | jq -e '.browser_download_url' > /dev/null 2>&1; then
                              echo "Successfully uploaded $file"
                              download_url=$(echo "$upload_response" | jq -r '.browser_download_url')
                              echo "Download URL: $download_url"
                          else
                              echo "Failed to upload $file"
                              echo "Response: $upload_response"
                          fi
                      else
                          echo "File $file does not exist, is too small (< 10MB), or is too large (> 2GB)"
                          if [ -f "$file" ]; then
                              file_size=$(stat -c %s "$file")
                              echo "File size: $file_size bytes"
                          fi
                      fi
                      echo "Cleaning up files for CentOS $version"
                      rm -f centos-${version}.qcow2 centos${version}.qcow2 centos-${version}.qcow2.bak
                      echo "=== Completed processing CentOS $version ==="
                      echo ""
                  done
                  echo "All CentOS versions processed!"